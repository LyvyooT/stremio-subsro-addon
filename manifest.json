const { addonBuilder, serveHTTP } = require('stremio-addon-sdk');
const fetch = require('node-fetch');
const cheerio = require('cheerio');

// Configurare manifest addon
const manifest = {
    id: 'ro.subs.stremio',
    version: '1.0.0',
    name: 'Subs.ro Subtitles',
    description: 'TitrÄƒri romÃ¢neÈ™ti automate de pe Subs.ro pentru Stremio',
    resources: ['subtitles'],
    types: ['movie', 'series'],
    catalogs: [],
    idPrefixes: ['tt']
};

const builder = new addonBuilder(manifest);

// FuncÈ›ie pentru cÄƒutare titrÄƒri pe subs.ro
async function searchSubsRo(title, year, season, episode) {
    try {
        let searchQuery = title;
        
        // ConstruieÈ™te query-ul de cÄƒutare
        if (season && episode) {
            searchQuery = `${title} S${String(season).padStart(2, '0')}E${String(episode).padStart(2, '0')}`;
        } else if (year) {
            searchQuery = `${title} ${year}`;
        }

        const searchUrl = `https://www.subs.ro/cautare.php?c=${encodeURIComponent(searchQuery)}`;
        
        const response = await fetch(searchUrl, {
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });
        
        const html = await response.text();
        const $ = cheerio.load(html);
        
        const subtitles = [];
        
        // Parse rezultatele cÄƒutÄƒrii
        $('.rezultat').each((i, elem) => {
            const $elem = $(elem);
            const link = $elem.find('a').attr('href');
            const titleText = $elem.find('.titlu').text().trim();
            const downloads = $elem.find('.downloads').text().trim();
            
            if (link) {
                subtitles.push({
                    id: `subsro:${link}`,
                    url: `https://www.subs.ro${link}`,
                    lang: 'ron', // Cod ISO 639-2 pentru romÃ¢nÄƒ
                    label: titleText || 'Subtitrare RomÃ¢nÄƒ',
                    downloads: downloads || '0'
                });
            }
        });
        
        return subtitles;
        
    } catch (error) {
        console.error('Eroare cÄƒutare subs.ro:', error);
        return [];
    }
}

// FuncÈ›ie pentru extragerea link-ului de download
async function getDownloadLink(subsUrl) {
    try {
        const response = await fetch(subsUrl, {
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });
        
        const html = await response.text();
        const $ = cheerio.load(html);
        
        // GÄƒseÈ™te link-ul de download
        const downloadLink = $('.buton_download').attr('href');
        
        if (downloadLink) {
            return `https://www.subs.ro${downloadLink}`;
        }
        
        return null;
        
    } catch (error) {
        console.error('Eroare extragere link download:', error);
        return null;
    }
}

// Handler pentru cereri de subtitles
builder.defineSubtitlesHandler(async (args) => {
    console.log('Cerere subtitles pentru:', args);
    
    const { type, id } = args;
    
    // Extrage informaÈ›ii din ID (format: tt1234567)
    const imdbId = id.split(':')[0];
    
    // Extrage sezon È™i episod dacÄƒ existÄƒ
    const season = args.season;
    const episode = args.episode;
    
    try {
        // ÃŽn producÈ›ie, ar trebui sÄƒ obÈ›ii titlul filmului/serialului din IMDB
        // Pentru simplificare, folosim un placeholder
        let title = 'placeholder'; // Aici ar trebui sÄƒ faci un fetch la IMDB API
        
        // CautÄƒ titrÄƒri
        const results = await searchSubsRo(title, null, season, episode);
        
        // ObÈ›ine link-urile de download
        const subtitles = await Promise.all(
            results.slice(0, 5).map(async (sub) => {
                const downloadUrl = await getDownloadLink(sub.url);
                return {
                    id: sub.id,
                    url: downloadUrl || sub.url,
                    lang: sub.lang,
                    label: `ðŸ‡·ðŸ‡´ ${sub.label}`
                };
            })
        );
        
        return Promise.resolve({ subtitles: subtitles.filter(s => s.url) });
        
    } catch (error) {
        console.error('Eroare handler subtitles:', error);
        return Promise.resolve({ subtitles: [] });
    }
});

// PorneÈ™te serverul
const port = process.env.PORT || 7000;

serveHTTP(builder.getInterface(), {
    port: port,
    cache: 3600 // Cache rezultatele pentru 1 orÄƒ
});

console.log(`Addon Subs.ro pornit pe http://localhost:${port}/manifest.json`);